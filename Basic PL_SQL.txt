CREATE DATABASE library;

USE library;

-- Table 1: Borrower
CREATE TABLE Borrower (
    Rollno INT(4),
    Name VARCHAR(20),
    DateofIssue DATE,
    NameofBook VARCHAR(30),
    Status VARCHAR(10)
);

INSERT INTO Borrower VALUES
(14, 'Ram', '2022-09-19', 'Operating System', 'I'),
(27, 'Soham', '2022-07-24', 'Object Oriented Programming', 'I'),
(34, 'Mohan', '2022-06-12', 'Microprocessor', 'I'),
(48, 'Om', '2022-04-19', 'Mechanics', 'I');

SELECT * FROM Borrower;

-- Table 2: Fine
CREATE TABLE Fine (
    Rollno INT(4),
    Date DATE,
    Amount INT(10)
);

DELIMITER //

-- Procedure to calculate fine
CREATE PROCEDURE calc_Fine(IN r INT(10), IN b VARCHAR(30))
BEGIN
    DECLARE doi DATE;
    DECLARE diff INT(3);

    SELECT DateofIssue INTO doi 
    FROM Borrower 
    WHERE Rollno = r AND NameofBook = b;

    SELECT DATEDIFF(CURDATE(), doi) INTO diff;

    IF diff >= 15 AND diff <= 30 THEN
        INSERT INTO Fine VALUES (r, CURDATE(), diff * 5);
    ELSEIF diff > 30 THEN
        INSERT INTO Fine VALUES (r, CURDATE(), diff * 50);
    END IF;
END //
DELIMITER ;

DELIMITER //

-- Procedure to submit a book and remove fine record
CREATE PROCEDURE submit(IN r INT(4))
BEGIN
    UPDATE Borrower SET Status = 'R' WHERE Rollno = r;
    DELETE FROM Fine WHERE Rollno = r;
END //
DELIMITER ;

-- Procedure Calls
CALL calc_Fine(14, 'Operating System'); 
CALL calc_Fine(27, 'Object Oriented Programming'); 
CALL calc_Fine(34, 'Microprocessor'); 
CALL calc_Fine(48, 'Mechanics'); 

SELECT * FROM Fine; 

CALL submit(14); 
CALL submit(27); 
CALL submit(48); 
CALL submit(34); 

SELECT * FROM Fine; 
SELECT * FROM Borrower;
